// Generator v√† Datasource
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// =====================================================
// CORE ENTITIES
// =====================================================

model Company {
  id                String   @id @default(cuid())
  name              String
  registrationNumber String   @unique
  address           String
  phone             String?
  email             String?
  contactPerson     String?
  stripeCustomerId  String?
  displayName       String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  profiles              Profile[]
  facilities            Facility[]
  products              Product[]
  usAgents              UsAgent[]
  fileUploads           FileUpload[]
  inventoryBalanceLogs  InventoryBalanceLog[]
  subscriptions         CompanySubscription[]
  paymentTransactions   PaymentTransaction[]
  invoices              Invoice[]
  subscriptionAuditLogs SubscriptionAuditLog[]
  overrides             CompanySubscriptionOverride[]
  overrideAuditLogs     SubscriptionOverrideAuditLog[]
  exporterFacilities    ExporterFacility[]

  @@map("companies")
}

model Profile {
  id              String   @id @default(cuid())
  companyId       String   @map("company_id")
  email           String   @unique
  fullName        String?  @map("full_name")
  role            String   @default("user")
  phone           String?
  position        String?
  isActive        Boolean  @default(true) @map("is_active")
  hashedPassword  String?  @map("hashed_password")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  company           Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  auditLogs         AuditLog[]
  activityLogs      ActivityLog[]
  dataExportLogs    DataExportLog[]
  notifications     Notification[]
  reportTemplates   ReportTemplate[]
  scheduleReports   ScheduledReport[]
  alertRules        AlertRule[]
  sessionTokens     SessionToken[]
  subscriptionLogs  SubscriptionAuditLog[]
  overrideLogs      SubscriptionOverrideAuditLog[]
  facilitiesCreated FacilityUpdateRequest[] @relation("requested_by")
  facilitiesReviewed FacilityUpdateRequest[] @relation("reviewed_by")
  overridesCreated  CompanySubscriptionOverride[]

  @@index([companyId])
  @@index([email])
  @@map("profiles")
}

model SessionToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("session_tokens")
}

// =====================================================
// FACILITIES & PRODUCTS
// =====================================================

model Facility {
  id                    String    @id @default(cuid())
  companyId             String    @map("company_id")
  name                  String
  facilityType          String    @map("facility_type")
  locationCode          String    @unique @map("location_code")
  address               String
  gpsCoordinates        String?   @map("gps_coordinates")
  certificationStatus   String?   @map("certification_status")
  agentRegistrationDate DateTime? @map("agent_registration_date")
  agentRegistrationYears Int       @default(1) @map("agent_registration_years")
  agentExpiryDate       DateTime? @map("agent_expiry_date")
  dunsNumber            String?   @map("duns_number")
  fdaFacilityNumber     String?   @map("fda_facility_number")
  fdaRegistrationDate   DateTime? @map("fda_registration_date")
  fdaExpiryDate         DateTime? @map("fda_expiry_date")
  fdaStatus             String    @default("pending") @map("fda_status")
  fdaRegistrationStatus String    @default("pending") @map("fda_registration_status")
  registrationEmail     String?   @map("registration_email")
  deletedAt             DateTime? @map("deleted_at")
  deletedBy             String?   @map("deleted_by")
  deletionReason        String?   @map("deletion_reason")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  company               Company                 @relation(fields: [companyId], references: [id], onDelete: Cascade)
  traceabilityLots      TraceabilityLot[]
  criticalTrackingEvents CriticalTrackingEvent[]
  shipments            Shipment[]              @relation("from_facility")
  shipmentsReceived     Shipment[]              @relation("to_facility")
  transformationEvents  TransformationEvent[]
  fdaRegistrations      FDARegistration[]
  auditReports          AuditReport[]
  updateRequests        FacilityUpdateRequest[]
  exporterFacilities    ExporterFacility[]

  @@index([companyId])
  @@index([locationCode])
  @@map("facilities")
}

model Product {
  id            String    @id @default(cuid())
  companyId     String    @map("company_id")
  productCode   String    @unique @map("product_code")
  productName   String
  productNameVi String?   @map("product_name_vi")
  description   String?   @map("description")
  category      String
  isFtl         Boolean   @default(false) @map("is_ftl")
  unitOfMeasure String    @map("unit_of_measure")
  requiresCte   Boolean   @default(true) @map("requires_cte")
  deletedAt     DateTime? @map("deleted_at")
  deletedBy     String?   @map("deleted_by")
  deletionReason String?   @map("deletion_reason")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  company          Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  traceabilityLots TraceabilityLot[]

  @@index([companyId])
  @@index([productCode])
  @@map("products")
}

// =====================================================
// TRACEABILITY CORE
// =====================================================

model TraceabilityLot {
  id                   String    @id @default(cuid())
  tlc                  String    @unique
  productId            String    @map("product_id")
  facilityId           String    @map("facility_id")
  batchNumber          String
  productionDate       DateTime  @map("production_date")
  expiryDate           DateTime? @map("expiry_date")
  quantity             Decimal   @db.Decimal(15, 2) @map("quantity")
  unit                 String
  status               String    @default("active") @map("status")
  availableQuantity    Decimal   @db.Decimal(15, 2) @map("available_quantity")
  reservedQuantity     Decimal   @default(0) @db.Decimal(15, 2) @map("reserved_quantity")
  shippedQuantity      Decimal   @default(0) @db.Decimal(15, 2) @map("shipped_quantity")
  parentTlcCount       Int       @default(0) @map("parent_tlc_count")
  childTlcCount        Int       @default(0) @map("child_tlc_count")
  isTransformedProduct Boolean   @default(false) @map("is_transformed_product")
  isArchived           Boolean   @default(false) @map("is_archived")
  archivedAt           DateTime? @map("archived_at")
  archivedBy           String?   @map("archived_by")
  archiveReason        String?   @map("archive_reason")
  deletedAt            DateTime? @map("deleted_at")
  deletedBy            String?   @map("deleted_by")
  deletionReason       String?   @map("deletion_reason")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  // Relations
  product               Product               @relation(fields: [productId], references: [id], onDelete: Cascade)
  facility              Facility              @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  criticalTrackingEvents CriticalTrackingEvent[]
  shipmentItems         ShipmentItem[]
  transformationInputs  TransformationInput[]
  transformationOutputs TransformationEvent[] @relation("output_tlc")
  chronologicalValidations ChronologicalOrderValidation[]
  inventoryBalanceLogs  InventoryBalanceLog[]

  @@index([productId])
  @@index([facilityId])
  @@index([tlc])
  @@index([status])
  @@map("traceability_lots")
}

model CriticalTrackingEvent {
  id               String    @id @default(cuid())
  tlcId            String    @map("tlc_id")
  facilityId       String    @map("facility_id")
  eventType        String    @map("event_type")
  eventDate        DateTime  @map("event_date")
  quantityProcessed Decimal   @db.Decimal(15, 2) @map("quantity_processed")
  unit             String
  location         String?   @map("location")
  operatorName     String?   @map("operator_name")
  temperature      Decimal?  @db.Decimal(5, 2) @map("temperature")
  notes            String?   @map("notes")
  status           String    @default("draft") @map("status")
  submittedAt      DateTime? @map("submitted_at")
  submittedBy      String?   @map("submitted_by")
  wasteActual      Decimal?  @db.Decimal(15, 2) @map("waste_actual")
  wasteExpected    Decimal?  @db.Decimal(15, 2) @map("waste_expected")
  wasteReason      String?   @map("waste_reason")
  deletedAt        DateTime? @map("deleted_at")
  deletedBy        String?   @map("deleted_by")
  deletionReason   String?   @map("deletion_reason")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  traceabilityLot TraceabilityLot @relation(fields: [tlcId], references: [id], onDelete: Cascade)
  facility        Facility        @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  keyDataElements KeyDataElement[]
  auditLogs       AuditLog[]

  @@index([tlcId])
  @@index([facilityId])
  @@index([eventType])
  @@index([eventDate])
  @@map("critical_tracking_events")
}

model KeyDataElement {
  id        String   @id @default(cuid())
  cteId     String    @map("cte_id")
  kdeCode   String    @map("kde_code")
  kdeName   String    @map("kde_name")
  kdeValue  String   @db.Text @map("kde_value")
  isRequired Boolean  @default(true) @map("is_required")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  criticalTrackingEvent CriticalTrackingEvent @relation(fields: [cteId], references: [id], onDelete: Cascade)

  @@index([cteId])
  @@map("key_data_elements")
}

model KDERequirement {
  id              String   @id @default(cuid())
  eventType       String    @map("event_type")
  kdeCode         String    @map("kde_code")
  kdeName         String    @map("kde_name")
  kdeDescription  String?   @map("kde_description")
  isRequired      Boolean  @default(true) @map("is_required")
  dataType        String   @default("text") @map("data_type")
  validationRules Json?    @db.Json @map("validation_rules")
  displayOrder    Int      @default(0) @map("display_order")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@unique([eventType, kdeCode])
  @@map("kde_requirements")
}

// =====================================================
// SHIPMENTS & TRANSFORMATIONS
// =====================================================

model Shipment {
  id             String    @id @default(cuid())
  shipmentNumber String    @unique @map("shipment_number")
  fromFacilityId String?   @map("from_facility_id")
  toFacilityId   String?   @map("to_facility_id")
  departureDate  DateTime? @map("departure_date")
  arrivalDate    DateTime? @map("arrival_date")
  carrierName    String?   @map("carrier_name")
  trackingNumber String?   @map("tracking_number")
  status         String    @default("preparing") @map("status")
  notes          String?   @map("notes")
  deletedAt      DateTime? @map("deleted_at")
  deletedBy      String?   @map("deleted_by")
  deletionReason String?   @map("deletion_reason")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  fromFacility  Facility?      @relation("from_facility", fields: [fromFacilityId], references: [id], onDelete: SetNull)
  toFacility    Facility?      @relation("to_facility", fields: [toFacilityId], references: [id], onDelete: SetNull)
  shipmentItems ShipmentItem[]

  @@index([fromFacilityId])
  @@index([toFacilityId])
  @@map("shipments")
}

model ShipmentItem {
  id         String   @id @default(cuid())
  shipmentId String    @map("shipment_id")
  tlcId      String    @map("tlc_id")
  quantity   Decimal  @db.Decimal(15, 2) @map("quantity")
  unit       String
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  shipment        Shipment        @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  traceabilityLot TraceabilityLot @relation(fields: [tlcId], references: [id], onDelete: Cascade)

  @@index([shipmentId])
  @@index([tlcId])
  @@map("shipment_items")
}

model TransformationEvent {
  id                 String   @id @default(cuid())
  outputTlcId        String    @map("output_tlc_id")
  transformationType String    @map("transformation_type")
  transformationDate DateTime  @map("transformation_date")
  facilityId         String    @map("facility_id")
  operatorName       String?   @map("operator_name")
  notes              String?   @map("notes")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  outputTlc            TraceabilityLot       @relation("output_tlc", fields: [outputTlcId], references: [id], onDelete: Cascade)
  facility             Facility              @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  transformationInputs TransformationInput[]

  @@index([outputTlcId])
  @@index([facilityId])
  @@map("transformation_events")
}

model TransformationInput {
  id               String   @id @default(cuid())
  transformationId String    @map("transformation_id")
  inputTlcId       String    @map("input_tlc_id")
  quantityUsed     Decimal  @db.Decimal(15, 2) @map("quantity_used")
  unit             String
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  transformation  TransformationEvent @relation(fields: [transformationId], references: [id], onDelete: Cascade)
  traceabilityLot TraceabilityLot     @relation(fields: [inputTlcId], references: [id], onDelete: Cascade)

  @@index([transformationId])
  @@index([inputTlcId])
  @@map("transformation_inputs")
}

// =====================================================
// AUDIT & COMPLIANCE
// =====================================================

model AuditLog {
  id             String   @id @default(cuid())
  tableName      String    @map("table_name")
  recordId       String    @map("record_id")
  action         String
  oldValues      Json?    @db.Json @map("old_values")
  newValues      Json?    @db.Json @map("new_values")
  changedColumns String?   @map("changed_columns")
  actorId        String?   @map("actor_id")
  ipAddress      String?   @map("ip_address")
  userAgent      String?   @map("user_agent")
  isCritical     Boolean  @default(false) @map("is_critical")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  actor                 Profile?               @relation(fields: [actorId], references: [id], onDelete: SetNull)
  criticalTrackingEvent CriticalTrackingEvent? @relation(fields: [recordId], references: [id], onDelete: Cascade)

  @@index([tableName, recordId])
  @@index([actorId])
  @@map("audit_logs")
}

model ChronologicalOrderValidation {
  id                String    @id @default(cuid())
  tlcId             String    @map("tlc_id")
  eventType         String    @map("event_type")
  eventDate         DateTime  @map("event_date")
  previousEventType String?   @map("previous_event_type")
  previousEventDate DateTime? @map("previous_event_date")
  isValid           Boolean
  validationMessage String?   @map("validation_message")
  createdAt         DateTime  @default(now()) @map("created_at")

  // Relations
  traceabilityLot TraceabilityLot @relation(fields: [tlcId], references: [id], onDelete: Cascade)

  @@index([tlcId])
  @@map("chronological_order_validations")
}

model UsAgent {
  id                      String   @id @default(cuid())
  companyId               String    @map("company_id")
  agentName               String
  agentAddress            String    @map("agent_address")
  agentPhone              String    @map("agent_phone")
  agentEmail              String    @map("agent_email")
  agentRegistrationNumber String?   @map("agent_registration_number")
  isActive                Boolean  @default(true) @map("is_active")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("us_agents")
}

model FDARegistration {
  id                 String   @id @default(cuid())
  facilityId         String    @map("facility_id")
  registrationNumber String   @unique @map("registration_number")
  registrationDate   DateTime  @map("registration_date")
  expiryDate         DateTime  @map("expiry_date")
  status             String   @default("active") @map("status")
  renewalReminderSent Boolean  @default(false) @map("renewal_reminder_sent")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  facility Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)

  @@index([facilityId])
  @@map("fda_registrations")
}

model AuditReport {
  id              String   @id @default(cuid())
  facilityId      String    @map("facility_id")
  auditDate       DateTime  @map("audit_date")
  auditorName     String    @map("auditor_name")
  auditType       String    @map("audit_type")
  findings        String?   @db.Text @map("findings")
  recommendations String?   @db.Text @map("recommendations")
  status          String   @default("completed") @map("status")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  facility Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)

  @@index([facilityId])
  @@map("audit_reports")
}

model ExporterFacility {
  id                 String   @id @default(cuid())
  companyId          String    @map("company_id")
  facilityId         String    @map("facility_id")
  facilityName       String    @map("facility_name")
  facilityAddress    String    @map("facility_address")
  facilityType       String    @map("facility_type")
  certificationNumber String?   @map("certification_number")
  isActive           Boolean  @default(true) @map("is_active")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  company  Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  facility Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("exporter_facilities")
}

// =====================================================
// BILLING & SUBSCRIPTIONS
// =====================================================

model ServicePackage {
  id           String   @id @default(cuid())
  name         String   @unique
  description  String?  @map("description")
  priceMonthly Decimal  @db.Decimal(10, 2) @map("price_monthly")
  priceYearly  Decimal  @db.Decimal(10, 2) @map("price_yearly")
  features     Json     @db.Json @map("features")
  limits       Json     @db.Json @map("limits")
  isActive     Boolean  @default(true) @map("is_active")
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  subscriptions CompanySubscription[]

  @@map("service_packages")
}

model CompanySubscription {
  id                  String   @id @default(cuid())
  companyId           String    @map("company_id")
  packageId           String    @map("package_id")
  billingCycle        String    @map("billing_cycle")
  pricePaid           Decimal  @db.Decimal(10, 2) @map("price_paid")
  startDate           DateTime  @map("start_date")
  endDate             DateTime  @map("end_date")
  status              String   @default("active") @map("status")
  autoRenew           Boolean  @default(true) @map("auto_renew")
  stripeSubscriptionId String?  @map("stripe_subscription_id")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  company             Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  package             ServicePackage       @relation(fields: [packageId], references: [id], onDelete: Cascade)
  paymentTransactions PaymentTransaction[]

  @@index([companyId])
  @@index([packageId])
  @@map("company_subscriptions")
}

model PaymentTransaction {
  id                  String   @id @default(cuid())
  companyId           String    @map("company_id")
  subscriptionId      String?   @map("subscription_id")
  amount              Decimal  @db.Decimal(10, 2) @map("amount")
  currency            String   @default("USD") @map("currency")
  paymentMethod       String    @map("payment_method")
  transactionId       String?   @unique @map("transaction_id")
  stripePaymentIntentId String?  @map("stripe_payment_intent_id")
  status              String   @default("pending") @map("status")
  paymentDate         DateTime? @map("payment_date")
  notes               String?   @map("notes")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  company      Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  subscription CompanySubscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@map("payment_transactions")
}

model Invoice {
  id                  String   @id @default(cuid())
  companyId           String    @map("company_id")
  invoiceNumber       String   @unique @map("invoice_number")
  invoiceDate         DateTime  @map("invoice_date")
  dueDate             DateTime  @map("due_date")
  amount              Decimal  @db.Decimal(10, 2) @map("amount")
  taxAmount           Decimal  @default(0) @db.Decimal(10, 2) @map("tax_amount")
  totalAmount         Decimal  @db.Decimal(10, 2) @map("total_amount")
  status              String   @default("pending") @map("status")
  paymentTransactionId String?  @map("payment_transaction_id")
  notes               String?   @map("notes")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("invoices")
}

model SubscriptionAuditLog {
  id             String   @id @default(cuid())
  companyId      String    @map("company_id")
  subscriptionId String?   @map("subscription_id")
  action         String
  oldValues      Json?    @db.Json @map("old_values")
  newValues      Json?    @db.Json @map("new_values")
  actorId        String?   @map("actor_id")
  notes          String?   @map("notes")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  company Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  actor   Profile? @relation(fields: [actorId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@map("subscription_audit_logs")
}

model CompanySubscriptionOverride {
  id            String    @id @default(cuid())
  companyId     String    @map("company_id")
  overrideType  String    @map("override_type")
  overrideValue Json      @db.Json @map("override_value")
  reason        String?   @map("reason")
  createdBy     String?   @map("created_by")
  expiresAt     DateTime? @map("expires_at")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  company   Company                        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  creator   Profile?                       @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  auditLogs SubscriptionOverrideAuditLog[]

  @@index([companyId])
  @@map("company_subscription_overrides")
}

model SubscriptionOverrideAuditLog {
  id         String   @id @default(cuid())
  companyId  String    @map("company_id")
  overrideId String?   @map("override_id")
  action     String
  oldValues  Json?    @db.Json @map("old_values")
  newValues  Json?    @db.Json @map("new_values")
  actorId    String?   @map("actor_id")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  company  Company                      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  override CompanySubscriptionOverride? @relation(fields: [overrideId], references: [id], onDelete: SetNull)
  actor    Profile?                     @relation(fields: [actorId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@map("subscription_override_audit_logs")
}

// =====================================================
// FILES & INVENTORY
// =====================================================

model FileUpload {
  id           String   @id @default(cuid())
  companyId    String    @map("company_id")
  fileName     String    @map("file_name")
  filePath     String    @map("file_path")
  fileSize     BigInt    @map("file_size")
  fileType     String    @map("file_type")
  uploadedBy   String?   @map("uploaded_by")
  relatedTable String?   @map("related_table")
  relatedId    String?   @map("related_id")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("file_uploads")
}

model InventoryBalanceLog {
  id             String   @id @default(cuid())
  companyId      String    @map("company_id")
  tlcId          String    @map("tlc_id")
  eventType      String    @map("event_type")
  quantityChange Decimal  @db.Decimal(15, 2) @map("quantity_change")
  balanceBefore  Decimal  @db.Decimal(15, 2) @map("balance_before")
  balanceAfter   Decimal  @db.Decimal(15, 2) @map("balance_after")
  referenceId    String?   @map("reference_id")
  referenceType  String?   @map("reference_type")
  notes          String?   @map("notes")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  company         Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  traceabilityLot TraceabilityLot @relation(fields: [tlcId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([tlcId])
  @@map("inventory_balance_logs")
}

// =====================================================
// REQUESTS & NOTIFICATIONS
// =====================================================

model FacilityUpdateRequest {
  id              String    @id @default(cuid())
  facilityId      String    @map("facility_id")
  requestedById   String    @map("requested_by_id")
  requestType     String    @map("request_type")
  currentValues   Json?     @db.Json @map("current_values")
  requestedValues Json      @db.Json @map("requested_values")
  reason          String    @map("reason")
  status          String    @default("pending") @map("status")
  reviewedBy      String?   @map("reviewed_by")
  reviewedAt      DateTime? @map("reviewed_at")
  reviewNotes     String?   @map("review_notes")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  facility        Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  requestedByUser Profile  @relation("requested_by", fields: [requestedById], references: [id], onDelete: Cascade)
  reviewedByUser  Profile? @relation("reviewed_by", fields: [reviewedBy], references: [id], onDelete: SetNull)

  @@index([facilityId])
  @@map("facility_update_requests")
}

model Notification {
  id           String    @id @default(cuid())
  userId       String    @map("user_id")
  title        String
  message      String
  type         String
  relatedTable String?   @map("related_table")
  relatedId    String?   @map("related_id")
  isRead       Boolean   @default(false) @map("is_read")
  readAt       DateTime? @map("read_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  // Relations
  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

// =====================================================
// ANALYTICS & REPORTING
// =====================================================

model ActivityLog {
  id           String   @id @default(cuid())
  userId       String    @map("user_id")
  action       String
  resourceType String?   @map("resource_type")
  resourceId   String?   @map("resource_id")
  metadata     Json?    @db.Json @map("metadata")
  ipAddress    String?   @map("ip_address")
  userAgent    String?   @map("user_agent")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("activity_logs")
}

model DataExportLog {
  id           String    @id @default(cuid())
  userId       String    @map("user_id")
  exportType   String    @map("export_type")
  filePath     String?   @map("file_path")
  fileSize     BigInt?   @map("file_size")
  filters      Json?     @db.Json @map("filters")
  status       String    @default("processing") @map("status")
  errorMessage String?   @map("error_message")
  createdAt    DateTime  @default(now()) @map("created_at")
  completedAt  DateTime? @map("completed_at")

  // Relations
  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("data_export_logs")
}

model ReportTemplate {
  id             String   @id @default(cuid())
  name           String
  description    String?   @map("description")
  templateType   String    @map("template_type")
  templateConfig Json     @db.Json @map("template_config")
  isSystem       Boolean  @default(false) @map("is_system")
  createdBy      String?   @map("created_by")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  creator          Profile?          @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  scheduledReports ScheduledReport[]

  @@index([templateType])
  @@map("report_templates")
}

model ScheduledReport {
  id             String    @id @default(cuid())
  templateId     String    @map("template_id")
  userId         String    @map("user_id")
  scheduleType   String    @map("schedule_type")
  scheduleConfig Json      @db.Json @map("schedule_config")
  isActive       Boolean  @default(true) @map("is_active")
  lastRunAt      DateTime? @map("last_run_at")
  nextRunAt      DateTime? @map("next_run_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  template ReportTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  user     Profile        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([userId])
  @@map("scheduled_reports")
}

model AlertRule {
  id          String   @id @default(cuid())
  name        String
  description String?   @map("description")
  ruleType    String    @map("rule_type")
  conditions  Json     @db.Json @map("conditions")
  actions     Json     @db.Json @map("actions")
  isActive    Boolean  @default(true) @map("is_active")
  createdBy   String?   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  creator   Profile?   @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  alertLogs AlertLog[]

  @@index([ruleType])
  @@map("alert_rules")
}

model AlertLog {
  id           String   @id @default(cuid())
  ruleId       String    @map("rule_id")
  triggeredAt  DateTime @default(now()) @map("triggered_at")
  triggerData  Json?    @db.Json @map("trigger_data")
  actionsTaken Json?    @db.Json @map("actions_taken")
  status       String   @default("sent") @map("status")
  errorMessage String?   @map("error_message")

  // Relations
  rule AlertRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([ruleId])
  @@map("alert_logs")
}

model SystemSetting {
  id           String   @id @default(cuid())
  settingKey   String   @unique @map("setting_key")
  settingValue Json     @db.Json @map("setting_value")
  description  String?   @map("description")
  isPublic     Boolean  @default(false) @map("is_public")
  updatedBy    String?   @map("updated_by")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}
